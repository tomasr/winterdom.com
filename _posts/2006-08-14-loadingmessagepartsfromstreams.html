---
layout: post
status: publish
published: true
title: Loading Message Parts from Streams
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 161
wordpress_url: http://winterdom.com/2006/08/loadingmessagepartsfromstreams
date: '2006-08-14 20:05:50 +0000'
date_gmt: '2006-08-14 20:05:50 +0000'
categories:
- BizTalk
tags: []
comments: []
---
<p><!--start_raw--><P>This is something I ran into tonight while testing a few things which I thought other people might be aware of. If you're creating arbitrary message parts in a multi-part message in a&nbsp;BizTalk orchestration, and you're loading your part's data from a Stream directly, be aware that you can only use&nbsp;a MemoryStream and not any arbitrary Stream implementation. </P><br />
<P>This will happen either if you call LoadFrom() on your new XLANGPart instance or if you call AddPart() to the XLANGMessage instance with the constructor that takes both an object (the stream you want to load the message to) and a string (the part name) overload.</P><br />
<P>The problem lies in that both of these methods eventually call into the GenericLoadFrom() method in the Microsoft.XLANGs.Core.Part class, which basically does the following:</P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">else</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000> </FONT><SPAN style="COLOR: blue">if</SPAN><FONT color=#000000> (source </FONT><SPAN style="COLOR: blue">is</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">Stream</SPAN><FONT color=#000000>)<?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" &#47;><o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>value1 = </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> Value(source </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">Stream</SPAN><FONT color=#000000>);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>}<o:p></o:p></FONT></SPAN></P><br />
<P>Which in turns calls this:</P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">public</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000> Value(</FONT><SPAN style="COLOR: teal">Stream</SPAN><FONT color=#000000> s)<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">if</SPAN><FONT color=#000000> ( s == </FONT><SPAN style="COLOR: blue">null</SPAN><FONT color=#000000> )<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">throw</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">ArgumentNullException</SPAN><FONT color=#000000>(</FONT><SPAN style="COLOR: maroon">"s"</SPAN><FONT color=#000000>);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">if</SPAN><FONT color=#000000> ( !s.CanRead )<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">throw</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">ArgumentException</SPAN><FONT color=#000000>(</FONT><SPAN style="COLOR: maroon">"!s.CanRead"</SPAN><FONT color=#000000>);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">if</SPAN><FONT color=#000000> ( !(s </FONT><SPAN style="COLOR: blue">is</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">ICloneable</SPAN><FONT color=#000000>) )<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: teal">MemoryStream</SPAN><FONT color=#000000> stream1 = s </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">MemoryStream</SPAN><FONT color=#000000>;<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">if</SPAN><FONT color=#000000> ( stream1 == </FONT><SPAN style="COLOR: blue">null</SPAN><FONT color=#000000> )<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">throw</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">ArgumentNullException</SPAN><FONT color=#000000>(</FONT><SPAN style="COLOR: maroon">"s as MemoryStream"</SPAN><FONT color=#000000>);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">byte</SPAN><FONT color=#000000>[] buffer1 = stream1.GetBuffer();<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>s = </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> ReadOnlyBufferStream(buffer1, (</FONT><SPAN style="COLOR: blue">int</SPAN><FONT color=#000000>)stream1.Length);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>IRefCountedStreamFactory factory1 = </FONT><SPAN style="COLOR: blue">new</SPAN><FONT color=#000000> ReplayableStreamStreamFactory(s);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">this</SPAN><FONT color=#000000>._assignRewriter(factory1);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P>As you can see, the problem arises if you have an arbitrary Stream that is not clonable or is not a MemoryStream, such as a lowly FileStream. </P><!--end_raw--></p>
