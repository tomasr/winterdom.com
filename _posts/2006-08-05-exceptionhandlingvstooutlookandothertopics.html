---
layout: post
status: publish
published: true
title: Exception Handling, VSTO, Outlook and other topics
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 760
wordpress_url: http://winterdom.com/2006/08/exceptionhandlingvstooutlookandothertopics
date: '2006-08-05 11:49:42 +0000'
date_gmt: '2006-08-05 11:49:42 +0000'
categories:
- ".NET"
- Architecture
- VSTO
tags: []
comments:
- id: 509
  author: David Ing
  author_email: david.ing@gmail.com
  author_url: http://www.from9till2.com
  date: '2006-08-05 16:12:49 +0000'
  date_gmt: '2006-08-05 16:12:49 +0000'
  content: |
    Tomas - Check out http:&#47;&#47;www.add-in-express.com&#47;outlook-extension&#47; - they've 'productized' a win32 hWnd hook approach to placing winforms inside Outlook.
    It's worked pretty well so far, and I can now get 'custom task pane' style UI all the way through from Outlook 2000 to Outlook 2007 - plus didn't have to handle multi-app domains due to the HTML&#47;Jscript&#47;COM&#47;etc web folder approach.
    As for the EntBlock - I switched to log4net - lighter.
    - David
- id: 510
  author: Tomas Restrepo
  author_email: tomasr@mvps.org
  author_url: http://www.winterdom.com/weblog/
  date: '2006-08-05 16:17:55 +0000'
  date_gmt: '2006-08-05 16:17:55 +0000'
  content: |
    Cool, seems pretty interesting. I'll definitely keep it in mind for the next time I'm in outlook land :)
---
<p><!--start_raw--><P>My good friend <A href="http:&#47;&#47;codebetter.com&#47;blogs&#47;sam.gentile&#47;">Sam Gentile</A> posted <A href="http:&#47;&#47;codebetter.com&#47;blogs&#47;sam.gentile&#47;archive&#47;2006&#47;08&#47;05&#47;148008.aspx">two</A> <A href="http:&#47;&#47;codebetter.com&#47;blogs&#47;sam.gentile&#47;archive&#47;2006&#47;08&#47;05&#47;148006.aspx">excellent</A> entries on his (and his team's) experience with their product deployment and the pitfalls and issues they ran into. Pretty good information overall. It's also quite timely for me as I was actually dealing with some of this stuff yesterday as well for the project I'm working on.<BR><BR>Sam's recommendation on global exception handlers is dead on: On smart clients built using Windows Forms, always remember to hook into both the Application.ThreadException and AppDomain.UnhandledException events. The first one will trap any unhandled exception ocurring in the main UI thread, while the second will trap any exception ocurring on other background and pooled threads you're using (and you will be using them, believe me). We also have our own custom pretty dialog to display the error information to the user as well as to allow him&#47;her to send an email-report of the error for diagnostics.<BR><BR>However, my issues with this turned out to be a little different: We had to get this working on a VSTO Outlook AddIn which spawned multiple AppDomains. Normally, the VSTO 2005 loader will create an AppDomain to host your AddIn (very nice, makes things much easier and safer); however, we're also using parts of the <A href="http:&#47;&#47;msdn.microsoft.com&#47;library&#47;default.asp?url=&#47;library&#47;en-us&#47;dnbda&#47;html&#47;OtlkCustInEntApp.asp">Elixir framework</A>. Specifically, we're using the facilities it has to allow you to present Windows Forms UserControls as "Views" in Outlook Folders the AddIn creates. This is a really nice functionality if you're basically using Outlook as a shell that hosts your application or to provide custom views of the information your application handles using Outlook facilities.<BR><BR>However, the problem is how this functionality works: It basically generates an HTML file on disk that presents your UserControl as an ActiveX Control inside the embedded Internet Explorer window that Outlook creates. This means that now part of your AddIn code is loading into the default AppDomain! Besides the security issues this creates (it is a fairly ugly hack, after all), it now means you need ensure your global exception handler gets installed into both AppDomains.<BR><BR>The way we accomplished this was though a simple GlobalErrorHandler class, like this:</P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;&#47;</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
<summary><?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" &#47;><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;&#47;</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> The GlobalErrorHandler class ensures<o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;&#47;</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> that we have hooked all necessary<o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;&#47;</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> events to capture unhandled exceptions in our appdomains.<o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;&#47;</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: gray; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"></summary><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">static</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000> </FONT><SPAN style="COLOR: blue">class</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: teal">GlobalErrorHandler<o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">public</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">static</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">void</SPAN><FONT color=#000000> Ensure()<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: green">&#47;&#47; hook WinForms<o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: teal">Application</SPAN><FONT color=#000000>.ThreadException += OnApplicationUnhandledException;<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: teal">AppDomain</SPAN><FONT color=#000000>.CurrentDomain.UnhandledException += OnDomainUnhandledException;<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">private</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">static</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">void</SPAN><FONT color=#000000> OnApplicationUnhandledException(</FONT><SPAN style="COLOR: blue">object</SPAN><FONT color=#000000> sender, </FONT><SPAN style="COLOR: teal">ThreadExceptionEventArgs</SPAN><FONT color=#000000> e)<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>HandleException(e.Exception);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">private</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">static</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">void</SPAN><FONT color=#000000> OnDomainUnhandledException(</FONT><SPAN style="COLOR: blue">object</SPAN><FONT color=#000000> sender, </FONT><SPAN style="COLOR: teal">UnhandledExceptionEventArgs</SPAN><FONT color=#000000> e)<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>HandleException((</FONT><SPAN style="COLOR: teal">Exception</SPAN><FONT color=#000000>)e.ExceptionObject);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: blue">private</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">static</SPAN><FONT color=#000000> </FONT><SPAN style="COLOR: blue">void</SPAN><FONT color=#000000> HandleException(</FONT><SPAN style="COLOR: teal">Exception</SPAN><FONT color=#000000> exp)<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>{<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes"><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN style="COLOR: teal">IErrorService</SPAN><FONT color=#000000> errorSvc = </FONT><SPAN style="COLOR: teal">AppContext</SPAN><FONT color=#000000>.GetService<</FONT><SPAN style="COLOR: teal">IErrorService</SPAN><FONT color=#000000>>();<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>errorSvc.HandleError(exp);<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN>}<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>} </FONT><SPAN style="COLOR: green">&#47;&#47; class GlobalErrorHandler<o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><br />
<P><br />
<P>Now all we had to do was ensure that GlobalErrorHandler.Ensure() was called as soon as the Outlook AddIn started and whenever one of our UserControls used as Outlook folder views got created. The global exception handler just uses our IErrorService implementation to deal with the unhandled exception (which shows the user the pretty dialog, among other things).</P><br />
<P>Sam also mentions the Exception Handling Block of the Enterprise Library. I think this one is the coolest of the application blocks in the Enterprise Library (and possibly the only one I like).&nbsp;What I like about it is not so much the&nbsp;configuration UI (though that can be nice), but the programming model it enforces&nbsp;throughout your application.&nbsp;We're currently not using it, as we feel we don't currently need that level of control, though we might consider doing so in the future. One of the reasons from shying away from getting it in right away is that I've had pretty lousy experiences when deploying solutions using the Enterprise Library,&nbsp;though I realize that's probably my fault :)</P><br />
<P>One of the issues that has made the deployment experience lousy for me has been the Enterprise Library Design. The EL team did a great job of instrumenting the Enterprise Library throughout all the code with performance counters, logging errors into the machine's application log and all that. Unfortunately, this causes some issues during deployment because both of these operations require that you install with (as far as I can tell) administrative privileges and that the library is installed correctly so that when the components are running under a different user account they don't fail because of access denied errors. </P><br />
<P>Unfortunately, this hasn't always worked right for me, and sometimes even though the library seems to install OK and running InstallUtil.exe and friends on them seems to work, I still get the access denied errors at runtime, which sucks, and working around these issues can be an exercise in frustration (particularly because you end up with the components failing because of stuff that is not their main purpose and for which many times I don't care&#47;need).</P><!--end_raw--></p>
