---
layout: post
status: publish
published: true
title: Testing Code That Invokes WebServices
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 115
wordpress_url: http://winterdom.com/2006/09/testingcodethatinvokeswebservices
date: '2006-09-18 12:11:29 +0000'
date_gmt: '2006-09-18 12:11:29 +0000'
categories:
- ".NET"
- Architecture
- Web Services
tags: []
comments: []
---
<p><!--start_raw-->
<p>I've been working on a solution lately that calls an existing WebService as part of the business functionality it implements. Obviously, I needed a good way of testing it, and I wanted to mention here a pattern I've used with good success for that. </p>
<p>The overall pattern I'm using now is a combination of several patterns, in particular <a href="http:&#47;&#47;msdn.microsoft.com&#47;practices&#47;apptype&#47;distapps&#47;default.aspx?pull=&#47;library&#47;en-us&#47;dnpatterns&#47;html&#47;DesServiceGateway.asp">Service Gateway</a> and a sub-<a href="http:&#47;&#47;msdn.microsoft.com&#47;practices&#47;apptype&#47;distapps&#47;default.aspx?pull=&#47;library&#47;en-us&#47;dnpatterns&#47;html&#47;DesServiceInterface.asp">Service Interface</a> (I'll explain this in a moment), coupled with the use of <a href="http:&#47;&#47;www.hanselman.com&#47;blog&#47;HanselminutesPodcast32MockObjects.aspx">Mock Objects</a> to support unit testing. In my case, I've been using lately <a href="http:&#47;&#47;www.ayende.com&#47;Blog&#47;">Ayende</a>'s <a href="http:&#47;&#47;www.ayende.com&#47;projects&#47;rhino-mocks.aspx">Rhino Mocks</a> library, which I've found excellent overall.</p>
<p><strong>The Service Interface</strong></p>
<p>The first thing I do to make testing the code calling the service easier is to clearly isolate the business code from the WebService call. This doesn't need to be a huge isolation necessarily (it depends on your needs), but it does mean adding one level of indirection between the calling code and your WebService proxy class. Here's where the patterns help a lot:</p>
<p>First, I&nbsp;define an interface for accessing the WebService, which may (or may not) match the actual interface of the service as exposed by the client-side proxy class. One reason to make it different might be if you only need a few of the operations exposed and not all of them. For example, if your service exposes a dozen of operations and you only need three of them, don't make your life harder by having to define and implement an interface more complex than it needs to be; keep it simple. This is why I call this a "Sub-Service Interface", since it isn't an straight Service Interface pattern implementation. </p>
<p>If&nbsp;you&nbsp;are using WCF to access the service, then by all means using the ServiceContract interface you get from WCF might be an acceptable compromise.</p>
<p>Having that interface is key to enabling the testability we want. With that interface in place, you can actually begin unit-testing your code right away (even before doing the next obvious step), by using Mock Objects to mock your new service. To make it easier to test, you'll also want to&nbsp;use an Inversion of Control pattern to hook&nbsp;the classes implementing your business logic with the implementation of your service interface. In my code, I use&nbsp;the <a href="http:&#47;&#47;www.castleproject.org&#47;index.php&#47;Container">Windsor container</a> from the Castle Project for this.</p>
<p><img height="332" src="http:&#47;&#47;www.winterdom.com&#47;weblog&#47;content&#47;binary&#47;TestingCodeThatInvokesWebServices_10D10&#47;ServiceInterface7.gif" width="564"> </p>
<p>Some things to keep in mind during your testing: You'll probably want to test the business code under several different situations, including simulating both when the service works correcty as well as when it fails. For example, in our current project there are several paths the code can follow when the service fails depending on what error it returns, and we want to be able to&nbsp;cover them all in our Unit tests.</p>
<p><strong>The Service Gateway</strong></p>
<p>Now that we have a service interface defined for the business logic to access our WebService, and we've tested the business code, we want to implement the code that actually calls the WebService. Obviously, much of that code is the proxy class generated by Visual Studio (or whatever tool you're using to generate it like <a href="http:&#47;&#47;www.thinktecture.com&#47;Resources&#47;Software&#47;WSContractFirst&#47;default.html">WSCF</a>, which we also use), but since we're adding a new level of indirection, we need to&nbsp;create a class that will implement our Sub-Service interface and will thus wrap the calls to the proxy class: our Service Gateway.</p>
<p><img height="443" src="http:&#47;&#47;www.winterdom.com&#47;weblog&#47;content&#47;binary&#47;TestingCodeThatInvokesWebServices_10D10&#47;ServiceGateway3.gif" width="637"> </p>
<p>In many cases, the Service Gateway will be trivial, and might just be a pass-through to the proxy class methods. Oftentimes, however, this will be a great place to centralize logic associated with the WebService call, like configuration and error handling.</p>
<p>For example, if&nbsp;the service you're calling implements WS-Security, the service gateway is a great place to handle the steps necessary to associate the correct security credentials to your service proxy class. For example, in our current project, we use WSE UsernameTokens to access the WebService. As it happens, the username and password to use to connect to the webservice cannot be embedded in any configuration file; instead they are stored in an external configuration system our client uses. Querying the&nbsp;external configuration system for the credentials information, creating the appropriate UsernameToken and associating it with the requests is done at the Service Gateway class, keeping the rest of the code clean and independent of these considerations.</p>
<p>Another example of why this is good: In our project, if the service call fails because of network-related issues, like a connection timeout or a connection refused, we're required to send a proactive alert about the problem; we can easily do this in a centralized fashion from our Service Gateway.</p>
<p>One interesting point here is that in our project, the Service Gateway class does not do data conversions, though in general I would recommend&nbsp;you do it. Some reasons we did otherwise this time were:</p>
<ol>
<li>Our interface is pretty simple, and there isn't really any complex data to transform
<li>The few transformations that are required are not uniform. In other words, not every place where a given operation is called is the transformation required.
<li>Those few simple transformations there are, we implemented in their own separate classes which were independently unit-tested, so hooking them into the business logic at the correct place was low-risk and because of (2) it actually meant less code we needed to write and test (i.e. a good thing).
<li>We have some error mapping transformations were we convert some of the error codes returned by the external WebService to a different representation. However, those error transformations again were not uniform, so trying to centralize them would actually mean more&nbsp;and more convoluted code.</li></ol>
<div class="wlWriterSmartContent" id="d7bf807d-7bb0-458a-811f-90c51817d5c2:94df9e96-d7a6-43d9-90a7-fc69ec022ca9" contenteditable="false" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">
<p><span class="TagSite"><img src="http:&#47;&#47;www.winterdom.com&#47;images&#47;technorati.png" alt="technorati"></span> <a href="http:&#47;&#47;technorati.com&#47;tag&#47;Unit+Testing" rel="tag" class="tag">Unit Testing</a>, <a href="http:&#47;&#47;technorati.com&#47;tag&#47;Web+Services" rel="tag" class="tag">Web Services</a><br &#47;><!-- StartInsertedTags: Unit Testing, Web Services :EndInsertedTags --></p></div><!--end_raw--></p>
