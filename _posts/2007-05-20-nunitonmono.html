---
layout: post
status: publish
published: true
title: NUnit on Mono
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 733
wordpress_url: http://winterdom.com/2007/05/nunitonmono
date: '2007-05-20 09:02:57 +0000'
date_gmt: '2007-05-20 09:02:57 +0000'
categories:
- ".NET"
tags: []
comments: []
---
<p><!--start_raw-->
<p>One of the things I've been working during these past few days in my spare time is rewriting the build system for a project I've been involved in. Though usually we just build directly in Visual Studio 2005 during development, we also need to target .NET 1.1 and <a href="http:&#47;&#47;www.mono-project.com&#47;">Mono</a> was always an idea. </p>
<p>What the project was originally doing was building against .NET 1.1 using <a href="http:&#47;&#47;www.codeplex.com&#47;MSBee">MSBee</a>. While this worked, it meant one more thing to install, and unfortunately, MSBee also has a few cumbersome requirements, particularly given that our build was pretty simple (meaning we didn't need much more than what the bare framework includes to build).</p>
<p>For mono, someone had created a long while ago a&nbsp;<a href="http:&#47;&#47;www.monodevelop.com&#47;Main_Page">MonoDevelop</a> solution and project files, but no one mantained them and were completely out of date. Fixing that would've been pretty cumbersome by hand.</p>
<p>So I really wanted to have something a bit more automated and that would allow us to build against any of the three targets easily. I particularly was interested in ensuring I could quickly build the project for all three targets before committing anything, to avoid breaking the build.</p>
<p>I ended up, of course, turning to trusty <a href="http:&#47;&#47;nant.sourceforge.net">NAnt</a>. In a couple of hours I had a decent set of buildfiles created that would require little maintainance and that could be used to build against all three targets. Add a couple of shell scripts on top of that to build for specific targets and I was done. </p>
<p>So far, I'm pretty happy with the results. I can build on my windows machine even against mono and it took very little effort to make it work on Linux as well (mostly just ensuring paths were in the correct case). However, unit tests, built using <a href="http:&#47;&#47;www.nunit.com&#47;">NUnit</a>,&nbsp;have been a bit of a problem.</p>
<p>Our tests run just fine in both .NET 2.0 and .NET 1.1 under Windows (both using the standalone NUnit GUI as well as under NAnt). However, they fail miserably under Mono.</p>
<p>Here's what I get running the tests on Windows using Mono 1.2.4 with NAnt 0.85:</p><br />
<blockquote>
<p>Stacktrace:<br>at (wrapper managed-to-native) System.Reflection.MonoMethod.InternalInvoke (object,object[]) <0x00004><br>at (wrapper managed-to-native) System.Reflection.MonoMethod.InternalInvoke (object,object[]) <0xffffffff><br>at System.Reflection.MonoMethod.Invoke (object,System.Reflection.BindingFlags,System.Reflection.Binder,object[],System.Globalization.CultureInfo) <0x00099><br>at System.Reflection.MonoProperty.GetValue (object,System.Reflection.BindingFlags,System.Reflection.Binder,object[],System.Globalization.CultureInfo) <0x00067><br>at System.Reflection.PropertyInfo.GetValue (object,object[]) <0x0001a><br>at NUnit.Core.TestFramework.GetAssertCount () <0x00073><br>at NUnit.Core.TestFixture.DoFixtureSetUp (NUnit.Core.TestResult) <0x00259><br>at NUnit.Core.TestSuite.DoOneTimeSetUp (NUnit.Core.TestResult) <0x00137><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0012a><br>at NUnit.Core.TestSuite.RunAllTests (NUnit.Core.TestSuiteResult,NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0023f><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0013d><br>at NUnit.Core.TestSuite.RunAllTests (NUnit.Core.TestSuiteResult,NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0023f><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0013d><br>at NUnit.Core.TestSuite.RunAllTests (NUnit.Core.TestSuiteResult,NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0023f><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0013d><br>at NUnit.Core.TestSuite.RunAllTests (NUnit.Core.TestSuiteResult,NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0023f><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0013d><br>at NUnit.Core.TestSuite.RunAllTests (NUnit.Core.TestSuiteResult,NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0023f><br>at NUnit.Core.TestSuite.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x0013d><br>at NUnit.Core.TestAssembly.Run (NUnit.Core.EventListener,NUnit.Core.IFilter) <0x00054><br>at NUnit.Core.SimpleTestRunner.Run (NUnit.Core.EventListener,NUnit.Core.Test[]) <0x0013d><br>at NUnit.Core.SimpleTestRunner.Run (NUnit.Core.EventListener,string[]) <0x0008b><br>at NUnit.Core.TestRunnerThread.TestRunnerThreadProc () <0x00029><br>at (wrapper delegate-invoke) System.MulticastDelegate.invoke_void () <0xffffffff><br>at (wrapper runtime-invoke) System.Object.runtime_invoke_void (object,intptr,intptr,intptr) <0xffffffff></p></blockquote>
<p>Under linux, using mono 1.2.3.1 with NAnt 0,85 (or even running Nunit 2.4.1 standalone), here's what I get:</p><br />
<blockquote>
<p>Native stacktrace:
<p>&#47;usr&#47;bin&#47;cli [0x818f7de]<br>&#47;usr&#47;bin&#47;cli [0x8171be4]<br>[0xffffe440]<br>&#47;usr&#47;lib&#47;libglib-2.0.so.0 [0xb7e77e9e]<br>&#47;usr&#47;bin&#47;cli [0x80d24b6]<br>&#47;usr&#47;bin&#47;cli [0x8171a51]<br>&#47;usr&#47;bin&#47;cli(mono_runtime_invoke+0x27) [0x80b038f]<br>&#47;usr&#47;bin&#47;cli(mono_runtime_delegate_invoke+0x62) [0x80b0617]<br>&#47;usr&#47;bin&#47;cli(mono_runtime_run_main+0x304) [0x80b4f0a]<br>&#47;usr&#47;bin&#47;cli(mono_jit_exec+0xbd) [0x805a55b]<br>&#47;usr&#47;bin&#47;cli [0x805a638]<br>&#47;usr&#47;bin&#47;cli(mono_main+0x1666) [0x805be3c]<br>&#47;usr&#47;bin&#47;cli [0x80596c6]<br>&#47;lib&#47;tls&#47;i686&#47;cmov&#47;libc.so.6(__libc_start_main+0xdc) [0xb7ce9ebc]<br>&#47;usr&#47;bin&#47;cli [0x8059621]
<p>Debug info from gdb:
<p>(no debugging symbols found)<br>Using host libthread_db library "&#47;lib&#47;tls&#47;i686&#47;cmov&#47;libthread_db.so.1".<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>[Thread debugging using libthread_db enabled]<br>[New Thread -1211291936 (LWP 22053)]<br>[New Thread -1226232944 (LWP 22057)]<br>[New Thread -1225180272 (LWP 22056)]<br>[New Thread -1220764784 (LWP 22055)]<br>[New Thread -1214997616 (LWP 22054)]<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>(no debugging symbols found)<br>0xffffe410 in __kernel_vsyscall ()<br>5 Thread -1214997616 (LWP 22054) 0xffffe410 in __kernel_vsyscall ()<br>4 Thread -1220764784 (LWP 22055) 0xffffe410 in __kernel_vsyscall ()<br>3 Thread -1225180272 (LWP 22056) 0xffffe410 in __kernel_vsyscall ()<br>2 Thread -1226232944 (LWP 22057) 0xffffe410 in __kernel_vsyscall ()<br>1 Thread -1211291936 (LWP 22053) 0xffffe410 in __kernel_vsyscall ()
<p>Thread 5 (Thread -1214997616 (LWP 22054)):<br>#0 0xffffe410 in __kernel_vsyscall ()<br>#1 0xb7e48986 in ?? () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libpthread.so.0<br>#2 0x0811700b in ?? ()<br>#3 0xb794939c in ?? ()<br>#4 0x00000000 in ?? ()
<p>Thread 4 (Thread -1220764784 (LWP 22055)):<br>#0 0xffffe410 in __kernel_vsyscall ()<br>#1 0xb7e455c6 in pthread_cond_wait@@GLIBC_2.3.2 ()<br>from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libpthread.so.0<br>#2 0x0811c14a in ?? ()<br>#3 0xb78b31dc in ?? ()<br>#4 0xb78b31c4 in ?? ()<br>#5 0xb73c9178 in ?? ()<br>#6 0x00000000 in ?? ()
<p>Thread 3 (Thread -1225180272 (LWP 22056)):<br>#0 0xffffe410 in __kernel_vsyscall ()<br>#1 0xb7d9405b in read () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libc.so.6<br>#2 0xb6f96291 in ?? ()<br>#3 0x00000009 in ?? ()<br>#4 0x00129010 in ?? ()<br>#5 0x00001000 in ?? ()<br>#6 0x00f93204 in ?? ()<br>#7 0x00129010 in ?? ()<br>#8 0x08527400 in ?? ()<br>#9 0x00001000 in ?? ()<br>#10 0x00000000 in ?? ()
<p>Thread 2 (Thread -1226232944 (LWP 22057)):<br>#0 0xffffe410 in __kernel_vsyscall ()<br>#1 0xb7e4584c in pthread_cond_timedwait@@GLIBC_2.3.2 ()<br>from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libpthread.so.0<br>#2 0x0811c1c7 in ?? ()<br>#3 0xb78b34d0 in ?? ()<br>#4 0xb78b34b8 in ?? ()<br>#5 0xb6e9204c in ?? ()<br>#6 0x00000000 in ?? ()
<p>Thread 1 (Threa<br />
d -1211291936 (LWP 22053)):<br>#0 0xffffe410 in __kernel_vsyscall ()<br>#1 0xb7d63f59 in fork () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libc.so.6<br>#2 0xb7e4a7e4 in fork () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libpthread.so.0<br>#3 0xb7eaf7d9 in ?? () from &#47;usr&#47;lib&#47;libglib-2.0.so.0<br>#4 0x00000010 in ?? ()<br>#5 0xb7e12128 in ?? () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libc.so.6<br>#6 0xb7e12150 in ?? () from &#47;lib&#47;tls&#47;i686&#47;cmov&#47;libc.so.6<br>#7 0x00000020 in ?? ()<br>#8 0x00000000 in ?? ()<br>#0 0xffffe410 in __kernel_vsyscall ()
<p>=================================================================<br>Got a SIGSEGV while executing native code. This usually indicates<br>a fatal error in the mono runtime or one of the native libraries<br>used by your application.<br>=================================================================
<p>Aborted (core dumped)</p></blockquote>
<p>I'm not quite sure that the two errors are related (I'm thinking I'm hitting different issues in both platforms), but even so I've been unable to find much useful info on what might be causing them. Anyone has any ideas?<br></p>
<div class="wlWriterSmartContent" id="0767317B-992E-4b12-91E0-4F059A8CECA8:19e2eefa-b9be-4585-954f-a9e1757425b6" contenteditable="false" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati tags: <a href="http:&#47;&#47;technorati.com&#47;tags&#47;.NET" rel="tag">.NET</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;Mono" rel="tag">Mono</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;NUnit" rel="tag">NUnit</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;NAnt" rel="tag">NAnt</a></div><!--end_raw--></p>
