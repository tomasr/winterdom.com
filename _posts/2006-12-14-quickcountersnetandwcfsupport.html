---
layout: post
status: publish
published: true
title: QuickCounters.net and WCF Support
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 130
wordpress_url: http://winterdom.com/2006/12/quickcountersnetandwcfsupport
date: '2006-12-14 20:02:47 +0000'
date_gmt: '2006-12-14 20:02:47 +0000'
categories:
- QuickCounters
- WCF
- WinFX
tags: []
comments: []
---
<p><!--start_raw-->
<p><a href="http:&#47;&#47;www.traceofthought.net&#47;">Scott Colestock</a> broke the news earlier today about his <a href="http:&#47;&#47;www.traceofthought.net&#47;PermaLink,guid,26200471-1a98-4687-9020-6f0091f07b22.aspx">QuickCounters</a> project. QuickCounters is a great library (and associated tools) for instrumenting applications using Windows NT performance counters in a simple way. It not only does the bulk of the work of dealing with the performance counter API (both for deployment as well as runtime), but it also has a simple and easy to use UI Client you can use to read the performance counters for your application.</p></p>
<p>A while ago I mentioned <a href="&#47;weblog&#47;2006&#47;09&#47;23&#47;WCFExtensibility.aspx">I was experimenting</a> with creating custom Windows Communication Foundation extensions to instrument WCF services. A little after that, Scott approached me and told me about QuickCounters and I immediately recognized that his stuff was way better than the very basic stuff I had, and agreed to modify my extensions to build on top of QuickCounters. Thanks to the very easy to use API in QC, it was a breeze to do. Scott also allowed me to integrate my extensions into the <a href="http:&#47;&#47;www.codeplex.com&#47;quickcounters">QuickCounters project</a> in CodePlex, in the QuickCounters.Wcf assembly, so it should be available to anyone wanting to use them.</p></p>
<p><strong>Instrumenting WCF Services</strong></p></p>
<p>The WCF extensions are very simple right now. What we have is a custom service behavior which injects an IDispatchMessageInspector, which internally calls the QC API to instrument the service calls. I've mentioned in the past why I switched from my original implementation using an <a href="&#47;weblog&#47;2006&#47;09&#47;27&#47;IParameterInspectorInWCF.aspx">IParameterInspector</a> implementation.</p></p>
<p>Applying the extensions can be done either through code or through configuration. Code-based instrumentation is done by applying the [InstrumentedService] attribute to your WCF service implementation class, like this:</p></p>
<p>[InstrumentedService]<br>public class VoucherService : IVoucherService</p></p>
<p>If you want to instrument the service through configuration, you can do this like this:</p>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span class="kwrd"><span style="color: rgb(76, 76, 76);"><</span></span><span class="html"><span style="color: rgb(76, 76, 76);">extensions</span></span><span class="kwrd"><span style="color: rgb(76, 76, 76);">></span></span><span style="color: rgb(76, 76, 76);"><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp; </span><span class="kwrd"><</span><span class="html">behaviorExtensions</span><span class="kwrd">></span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwrd"><</span><span class="html">add</span> <span class="attr">name</span><span class="kwrd">="instrumentedService"</span> <span class="attr">type</span><span class="kwrd">="QuickCounters.Wcf.Configuration.InstrumentedServiceElement, <o:p></o:p></span></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span class="kwrd"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>QuickCounters.Wcf, Version=1.0.0.0, Culture=neutral, PublicKeyToken=401c7ea1618cbd56"</span></span><span style="color: rgb(76, 76, 76);"><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwrd">&#47;></span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp; </span><span class="kwrd"></</span><span class="html">behaviorExtensions</span><span class="kwrd">></span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span class="kwrd"><span style="color: rgb(76, 76, 76);"></</span></span><span class="html"><span style="color: rgb(76, 76, 76);">extensions</span></span><span class="kwrd"><span style="color: rgb(76, 76, 76);">></span></span><span style="color: rgb(76, 76, 76);"><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);">...<o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span class="kwrd"><span style="color: rgb(76, 76, 76);"><</span></span><span class="html"><span style="color: rgb(76, 76, 76);">serviceBehaviors</span></span><span class="kwrd"><span style="color: rgb(76, 76, 76);">></span></span><span style="color: rgb(76, 76, 76);"><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp; </span><span class="kwrd"><</span><span class="html">behavior</span> <span class="attr">name</span><span class="kwrd">="ServiceBehaviors"</span> <span class="kwrd">></span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwrd"><</span><span class="html">instrumentedService</span> <o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="attr">service</span><span class="kwrd">="MyService"</span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="attr">enableHttpGet</span><span class="kwrd">="true"</span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="attr">address</span><span class="kwrd">="qc"</span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="attr">applicationName</span><span class="kwrd">="MyApplication"</span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwrd">&#47;></span><o:p></o:p></span></pre>
<pre style="background: white none repeat scroll 0%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;"><span style="color: rgb(76, 76, 76);"><span style="">&nbsp;&nbsp; </span><span class="kwrd"></</span><span class="html">behavior</span><span class="kwrd">></span><o:p></o:p></span></pre></p>
<p><span class="kwrd"><span style="font-size: 11pt; color: rgb(76, 76, 76); line-height: 115%; font-family: 'Calibri','sans-serif';"></</span></span><span class="html"><span style="font-size: 11pt; color: rgb(76, 76, 76); line-height: 115%; font-family: 'Calibri','sans-serif';">serviceBehaviors</span></span><span class="kwrd"><span style="font-size: 11pt; color: rgb(76, 76, 76); line-height: 115%; font-family: 'Calibri','sans-serif';">></span></span></p></p>
<p><strong>QC Metadata</strong> </p></p>
<p>If you've read the project documentation, you'll know that besides adding the attribute&#47;behavior in WCF to enable the instrumentation, you also need to configure your performance counters through QuickCounters. For this, you need a simple metadata XML file that tells QuickCounters what your service is called and what types of requests it contains. While the schema is extremely simple, it can be cumbersome to create. </p></p>
<p>Fortunately, creating the metadata XML is trivial to do using tools. The QuickCounters project offers two alternatives for this: The first one is a standalone command line tool called QCFromWSDL.exe, which will use your service WSDL file and generate the corresponding QC XML file. </p></p>
<p>The second one, however, is far more interesting, and it's the result of all the work I've talked about before on publishing arbitrary <a href="&#47;weblog&#47;2006&#47;11&#47;01&#47;HackingMyWayIntoAnArbitraryEndpointInAWCFService.aspx">metadata</a> <a href="&#47;weblog&#47;2006&#47;11&#47;12&#47;WCFArbitraryEndpointAndIIS.aspx">endpoints</a> for a WCF Service. So here's how it works. The QuickCounters.Wcf behavior contains an enableHttpGet boolean property. If it is set to true, and your service is exposed via HTTP, then the behavior will automatically inject a new endpoint at the <service base address>&#47;<br />
<address_property_value> URI that can be retrieved using an HTTP GET operation. </p></p>
<p>So, for example, if your service is published at the http:&#47;&#47;localhost&#47;VoucherService&#47;VoucherService.svc URL, and the value of the "address" property for your InstrumentedService behavior&#47;attribute is set to the value "qc", this new endpoint will be published at <a href="http:&#47;&#47;localhost&#47;VouchedService&#47;VoucherService.svc&#47;qc">http:&#47;&#47;localhost&#47;VouchedService&#47;VoucherService.svc&#47;qc</a>. </p></p>
<p><em>[Note: All&nbsp;this properties are available both for the code-based attribute as well as the config file tag].</em> </p></p>
<p>When you navigate to this endpoint using your browser (or the QuickCounters tooling), you'll get an auto-generated QuickCounters XML metadata file you can use right away. </p></p>
<p><img src="&#47;weblog&#47;content&#47;binary&#47;WindowsLiveWriter&#47;WCFArbitraryEndpointandIIS_9AFE&#47;QC_IE%5B2%5D.png"> </p></p>
<p>Oh and by the way, the "ApplicationName" and "Service" properties allow you to override the InstrumentedApplication&#47;Name and Component&#47;Name fields in the generated XML. </p></p>
<p><strong>Future Plans</strong> </p></p>
<p>I hope people find these extensions useful. The QuickCounters library is a great tool that I will be using quite a bit in future projects, and I rather like using it alongside with the WCF extensions over (or rather as a complement to) the built-in performance instrumentation in WCF. </p></p>
<p>I will also be extending this to support new use cases. In particular, I hope to add a new behavior to instrument client-side proxies, and eventually hope to be able to instrument callback contracts on the server as well. If you find any problems, bugs or have any suggestions, we'd sure appreciate them as we hope to make this as useful and trouble-free as possible! Enjoy!</p></p>
<p></p></p>
<div class="wlWriterSmartContent" id="0767317B-992E-4b12-91E0-4F059A8CECA8:eb535860-b0c6-4b71-95be-a3b7964f784e" contenteditable="false" style="margin: 0px; padding: 0px; display: inline;">Technorati tags: <a href="http:&#47;&#47;technorati.com&#47;tags&#47;WCF" rel="tag">WCF</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;QuickCounters" rel="tag">QuickCounters</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;Instrumentation" rel="tag">Instrumentation</a></div></p>
<p></p><!--end_raw--></p>
