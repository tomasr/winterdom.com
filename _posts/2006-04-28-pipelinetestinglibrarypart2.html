---
layout: post
status: publish
published: true
title: Pipeline Testing Library - Part 2
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 259
wordpress_url: http://winterdom.com/2006/04/pipelinetestinglibrarypart2
date: '2006-04-28 09:53:22 +0000'
date_gmt: '2006-04-28 09:53:22 +0000'
categories:
- BizTalk
tags: []
comments: []
---
<p><!--start_raw--></p>
<p>Continuing from <a href="http:&#47;&#47;www.winterdom.com&#47;weblog&#47;2006&#47;04&#47;27&#47;PipelineTestingLibraryPart1.aspx">part<br />
1</a>, we'll now see how to handle schemas and execute receive and send<br />
pipelines with the pipeline testing library.</p></p>
<p><strong>Configuring Known Document Specifications</strong></p></p>
<p>If you want to use an assembler or disassembler on your pipeline, you'll need<br />
to make sure that it can resolve the necessary schemas based on the fully<br />
qualified schema type, or the root element name (namespace#root). To accomplish<br />
this, you'll need to make sure that the pipeline is aware of "known" document<br />
specifications before you execute them, so that the mock pipeline context can<br />
return the correct value when IPipelineContext.GetDocumentSpecByName() or<br />
IPipelineContext.GetDocumentSpecByType() is invoked by the<br />
assembler&#47;disassembler component.</p></p>
<p>The library supports this through the AddDocSpec() method on the<br />
ReceivePipelineWrapper and SendPipelineWrapper classes. AddDocSpec() takes as an<br />
argument a Type handle referencing the strongly-typed, SchemaBase-derived class<br />
generated by the BizTalk project system when you compile an schema into a<br />
BizTalk Assembly. Here's an example:</p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">ReceivePipelineWrapper</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
pipeline <span style="COLOR: blue">=</span> <?xml:namespace prefix="o" ns="urn:schemas-microsoft-com:office:office"?><o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: teal">PipelineFactory</span><span style="COLOR: blue">.</span>CreateEmptyReceivePipeline();<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">pipeline<span style="COLOR: blue">.</span>AddDocSpec(<span style="COLOR: blue">typeof</span>(Schema2_WPP));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p></o:p></span></p></p>
<p><p>AddDocSpec() will automatically handle multi-root schemas and make all roots<br />
in the schema known to the pipeline context, so you don't have to worry about<br />
that. You can also add as many document specifications as needed, as long as<br />
there are no conflicts among them (i.e. don't add two schemas with the<br />
conflicting namespace#root names).</p></p>
<p><strong>Executing Pipelines</strong></p></p>
<p>Now that we can configure the necessary components and schemas into our<br />
pipelines, we are ready to execute them. For both receive and send pipelines,<br />
you execute them using the Execute() method. However, it is defined with a<br />
different signature in both the ReceivePipelineWrapper and SendPipelineWrapper<br />
classes: Receive pipelines take a single IBaseMessage argument and return<br />
multiple messages in a MessageCollection object. Send pipelines, on the other<br />
hand, take&nbsp;multiple messages in a MessageCollection object as input and<br />
return a single IBaseMessage object as ouput.</p></p>
<p>Here's a complete example of configuring and executing a receive<br />
pipeline:</p></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">ReceivePipelineWrapper</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
pipeline <span style="COLOR: blue">=</span> <o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: teal">PipelineFactory</span><span style="COLOR: blue">.</span>CreateReceivePipeline(<span style="COLOR: blue">typeof</span>(ReceivePipeline1));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Create the input message to pass through the pipeline<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">Stream</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
stream <span style="COLOR: blue">=</span> <span style="COLOR: teal">DocLoader</span><span style="COLOR: blue">.</span>LoadStream(<span style="COLOR: maroon">"SampleDocument.xml"</span>);<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">IBaseMessage</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
inputMessage <span style="COLOR: blue">=</span> <span style="COLOR: teal">MessageHelper</span><span style="COLOR: blue">.</span>CreateFromStream(stream); <o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Add the necessary schemas to the pipeline, so that<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
disassembling works<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">pipeline<span style="COLOR: blue">.</span>AddDocSpec(<span style="COLOR: blue">typeof</span>(Schema1_NPP));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">pipeline<span style="COLOR: blue">.</span>AddDocSpec(<span style="COLOR: blue">typeof</span>(Schema2_WPP));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Execute the pipeline, and check the output<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">MessageCollection</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
outputMessages <span style="COLOR: blue">=</span> pipeline<span style="COLOR: blue">.</span>Execute(inputMessage);<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p>&nbsp;</o:p></span></p></p>
<p><p>Here's a complete example of executing a send pipeline, with multiple<br />
inputs:</p></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">SendPipelineWrapper</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
pipeline <span style="COLOR: blue">=<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: teal">PipelineFactory</span><span style="COLOR: blue">.</span>CreateSendPipeline(<span style="COLOR: blue">typeof</span>(Env_SendPipeline));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Create the input message to pass through the pipeline<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">string</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
body <span style="COLOR: blue">=</span> <o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><span style="COLOR: maroon">@"<o:Body<br />
xmlns:o='http:&#47;&#47;SampleSchemas.SimpleBody'><o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>this is a<br />
body</o:Body>"</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">;<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">MessageCollection</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
inputMessages <span style="COLOR: blue">=</span> <span style="COLOR: blue">new</span> <span style="COLOR: teal">MessageCollection</span>();<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">inputMessages<span style="COLOR: blue">.</span>Add(<span style="COLOR: teal">MessageHelper</span><span style="COLOR: blue">.</span>CreateFromString(body));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">inputMessages<span style="COLOR: blue">.</span>Add(<span style="COLOR: teal">MessageHelper</span><span style="COLOR: blue">.</span>CreateFromString(body));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">inputMessages<span style="COLOR: blue">.</span>Add(<span style="COLOR: teal">MessageHelper</span><span style="COLOR: blue">.</span>CreateFromString(body));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Add the necessary schemas to the pipeline, so that<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
assembling works<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">pipeline<span style="COLOR: blue">.</span>AddDocSpec(<span style="COLOR: blue">typeof</span>(SimpleBody));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">pipeline<span style="COLOR: blue">.</span>AddDocSpec(<span style="COLOR: blue">typeof</span>(SimpleEnv));<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><o:p>&nbsp;</o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
Execute the pipeline, and check the output<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
we get a single message batched with all the <o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: green; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">&#47;&#47;<br />
messages grouped into the envelope's body<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: teal; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">IBaseMessage</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><br />
outputMessage <span style="COLOR: blue">=</span> pipeline<span style="COLOR: blue">.</span>Execute(inputMessages);<o:p></o:p></span></p></p>
<p class="MsoNormal" style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p>&nbsp;</o:p></span></p></p>
<p>&nbsp;</p><!--end_raw--></p>
