---
layout: post
status: publish
published: true
title: WF Event Activities (2)
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 217
wordpress_url: http://winterdom.com/2006/03/wfeventactivities2
date: '2006-03-05 09:08:58 +0000'
date_gmt: '2006-03-05 09:08:58 +0000'
categories:
- WinFX
- Workflow
tags: []
comments: []
---
<p><!--start_raw-->
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">In a previous post I introduced event activities in Windows Workflow Foundation and what were the basics of how to create one. Now that we know which interfaces we need to implement, let's see now how to actually implement one.</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">In a regular activity, the basic lifetime is fairly simple: you would basically override the Execute() method, do your work and return ActivityExecutionStatus.Closed. If you needed to do your work asynchronously, you'd return ActivityExecutionStatus.Executing, and then eventually report your status as Closed. For asynchronous activities, you'd probably want to override Cancel(), as well. Of course, let us not forget Initialize() which will be the first thing to execute.</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">The same sequence of events applies to an Event Activity. Almost. This is because there are other methods that are called interleaved with the regular Activity methods which are important. Furthermore, you ideally want your activity to be able to execute in a regular scenario as well as inside an EventDrivenActivity, while reusing as much of your code as possible between the two possible execution paths.</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">The basic sequence of things for an Event Activity inside an EventDrivenActivity is a little bit different. Here's a quick review of the workflow that occurs:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<ol style="margin-top: 0in;" type="1">
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Initialize() is called on your activity, as usual</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">IEventActivity.Subscribe() is called on your activity by your parent EventDrivenActivity</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Your parent EventDrivenActivity is notified of your event through its IEventActivityListener<QueueEventArgs>.OnEvent implementation.</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">IEventActivity.Unsubscribe() is called on your activity by your parent EventDrivenActivity</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Execute() is called</font></li></ol></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Let us look now then at what you would do in each of these steps to ensure your Event Activity works and that you can reuse most of the code in both scenarios:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000"><font face="Tahoma"><b style=""><span style="font-size: 16pt;">1</span></b> When Initialize() is called, do anything you need to initialize your activity. This is also a good place to generate a unique name for the WorkflowQueue you'll use later to communicate with your runtime service (a GUID is a good choice).</font></font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000"><font face="Tahoma"><b style=""><span style="font-size: 16pt;">2</span></b> Your parent EventDrivenActivity subscribes to events on your activity's workflow queue by calling IEventActivity.Subscribe() on your instance. This means that it will be your parent activity which will get notified when something happens on the WorkflowQueue instance that you created to communicate with your runtime service, and not your own activity. This is the reason why IEventActivityListener<QueueEventArgs>.OnEvent will not get called when you are inside an EventDrivenActivity, but you'll still want to implement it to simplify your code when running as a regular activity.</font></font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Normally, here all you would do is ask your runtime service to do an operation from you and to put the result into a workflow queue you created for this piurpose. You'd then subscribe your parent activity in your Subscribe() implementation to the QueueItemAvailable event of your workflow queue, by using WorkflowQueuingService.RegisterForQueueItemAvailable(). Here's some example code out of my MsmqReceiveActivity:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="color: blue; font-family: Consolas;">void</span><span style="font-family: Consolas;"><font color="#000000"> </font><span style="color: teal;">IEventActivity</span><span style="color: blue;">.</span><font color="#000000">Subscribe(</font><span style="color: teal;">ActivityExecutionContext</span><font color="#000000"> parentContext, <o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">IActivityEventListener</span><span style="color: blue;"><</span><span style="color: teal;">QueueEventArgs</span><span style="color: blue;">></span><font color="#000000"> parentEventHandler)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000">{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( parentContext </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: blue;">null</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">throw</span><font color="#000000"> </font><span style="color: blue;">new</span><font color="#000000"> </font><span style="color: teal;">ArgumentNullException</span><font color="#000000">(</font><span style="color: maroon;">"parentContext"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( parentEventHandler </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: blue;">null</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">throw</span><font color="#000000"> </font><span style="color: blue;">new</span><font color="#000000"> </font><span style="color: teal;">ArgumentNullException</span><font color="#000000">(</font><span style="color: maroon;">"parentEventHandler"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">TraceUtil</span><span style="color: blue;">.</span><font color="#000000">WriteInfo(</font><span style="color: maroon;">"MsmqReceiveActivity::Subscribe({0})"</span><font color="#000000">, <o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>parentContext</font><span style="color: blue;">.</span><font color="#000000">Activity</font><span style="color: blue;">.</span><font color="#000000">Name);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">WorkflowQueue</span><font color="#000000"> queue </font><span style="color: blue;">=</span><font color="#000000"> GetWorkflowQueue(parentContext);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>queue</font><span style="color: blue;">.</span><font color="#000000">RegisterForQueueItemAvailable(parentEventHandler, QualifiedName);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">MsmqListenerService</span><font color="#000000"> msmqSvc </font><span style="color: blue;">=</span><font color="#000000"> <o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>parentContext</font><span style="color: blue;">.</span><font color="#000000">GetService</font><span style="color: blue;"><</span><span style="color: teal;">MsmqListenerService</span><span style="color: blue;">></span><font color="#000000">();<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>_subscriptionID </font><span style="color: blue;">=</span><font color="#000000"> msmqSvc</font><span style="color: blue;">.</span><font color="#000000">Subscribe(_wfQueueName, Queue);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000">}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Arial;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Arial;"><font color="#000000">Notice how we pass our parent&rsquo;s event handler to RegisterQueueItemAvailable() instead of our own.<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000"><font face="Tahoma"><b style=""><span style="font-size: 16pt;">3</span></b> Now, things are completely left to your runtime service, which must wait for the external event to happen. Once the external event occurs, it must enqueue a notification into the WorkflowQueue instance you provided to it. This usually means that at the very least your runtime service needs to know which events are of interest to which workflow instances, and possibly do much more (for example, if you implement correlation, this is where you&rsquo;ll need to figure out which correlations are met by an incoming event).</font></font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">In the case of my MsmqReceiveActivity, the runtime service is fairly simple: It basically keeps a dictionary of workflow instances (activities) that are interested in messages from a given MSMQ queue. When a message arrives at said MSMQ queue, it extracts the data from the message and then writes it into the WorkflowQueue provided when the activity &ldquo;subscribed&rdquo; to the queue.</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000"><font face="Tahoma"><b style=""><span style="font-size: 16pt;">4</span></b> When the actions on the WorkflowQueue you requested notification for happen (i.e. when your runtime service has posted an actual event to the queue), your parent EventDrivenActivity will get notified of this; however, it will not actually remove the event data from the WorkflowQueue. </font></font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Now, your parent activity will unsubscribe for your activity's workflow queue events by calling IEventActivity.Unsubscribe() on your activity, since it already has received the notification it was waiting for. Here you would typically just ask your runtime service to stop notifying you of events, and then unregister from the WorkflowQueue events by calling WorkflowQueuingService.UnregisterForQueueItemAvailable() (or whatever action suits your).</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">However, it is very important that here you do <i style="">not</i> delete the workflow queue; you'll need it in the next step. Here&rsquo;s some sample code:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="color: blue; font-family: Consolas;">void</span><span style="font-family: Consolas;"><font color="#000000"> </font><span style="color: teal;">IEventActivity</span><span style="color: blue;">.</span><font color="#000000">Unsubscribe(</font><span style="color: teal;">ActivityExecutionContext</span><font color="#000000"> parentContext, <o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">IActivityEventListener</span><span style="color: blue;"><</span><span style="color: teal;">QueueEventArgs</span><span style="color: blue;">></span><font color="#000000"> parentEventHandler)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000">{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( parentContext </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: blue;">null</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">throw</span><font color="#000000"> </font><span style="color: blue;">new</span><font color="#000000"> </font><span style="color: teal;">ArgumentNullException</span><font color="#000000">(</font><span style="color: maroon;">"parentContext"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( parentEventHandler </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: blue;">null</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">throw</span><font color="#000000"> </font><span style="color: blue;">new</span><font color="#000000"> </font><span style="color: teal;">ArgumentNullException</span><font color="#000000">(</font><span style="color: maroon;">"parentEventHandler"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">TraceUtil</span><span style="color: blue;">.</span><font color="#000000">WriteInfo(</font><span style="color: maroon;">"MsmqReceiveActivity::Unsubscribe({0})"</span><font color="#000000">, <o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>parentContext</font><span style="color: blue;">.</span><font color="#000000">Activity</font><span style="color: blue;">.</span><font color="#000000">Name);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; Tell our runtime Service that we are not interested<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; in messages arriving at the MSMQ Queue anymore.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">MsmqListenerService</span><font color="#000000"> msmqSvc </font><span style="color: blue;">=</span><font color="#000000"> (</font><span style="color: teal;">MsmqListenerService</span><font color="#000000">)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>parentContext</font><span style="color: blue;">.</span><font color="#000000">GetService(</font><span style="color: blue;">typeof</span><font color="#000000">(</font><span style="color: teal;">MsmqListenerService</span><font color="#000000">));<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>msmqSvc</font><span style="color: blue;">.</span><font color="#000000">Unsubscribe(_subscriptionID);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>_subscriptionID </font><span style="color: blue;">=</span><font color="#000000"> </font><span style="color: teal;">Guid</span><span style="color: blue;">.</span><font color="#000000">Empty;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">WorkflowQueue</span><font color="#000000"> queue </font><span style="color: blue;">=</span><font color="#000000"> GetWorkflowQueue(parentContext);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>queue</font><span style="color: blue;">.</span><font color="#000000">UnregisterForQueueItemAvailable(parentEventHandler);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><font color="#000000">}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Arial;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000"><font face="Tahoma"><b style=""><span style="font-size: 16pt;">5</span></b> Now your parent EventDrivenActivity will actually proceed to request the WorkflowRuntime to execute your activity, which will result in your Execute() method getting called. What you'll do here is just get the event data out of your WorkflowQueue (this is why you can't delete it in the previous step!) and process it. Once you're done, you'll want to delete your workflow queue, and let the runtime now you're done executing. </font></font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Since we want to reuse our code as much as possible, you might be wondering that this is obviously not going to work when you are not in an EventDrivenActivity, and you&rsquo;d be right. This is why you want to do a few tests first. To ensure the code works in both scenarios, you&rsquo;ll want to implement your Execute() a little differently. Here&rsquo;s how:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<ul style="margin-top: 0in;" type="disc">
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Check to see if you&rsquo;ve already created a WorkflowQueue. If so, check to see if there are any pending notifications on it (by simply checking how many items the queue has). If it has one, great, you were inside an EventDrivenActivity and your event was actually called. Just get the event data out and process it.</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">If there are no pending notifications in the queue, then subscribe to yourself, and tell the workflow runtime that you&rsquo;re not finished executing. This, in essence, means calling your own IEventActivity.Subscribe() implementation, passing your implementation of IActivityEventListener<QueueEventArgs> as the second argument. Now, when the actual event fires, your activity will get notified and you can, again, simply process the data from the WorkflowQueue and let the runtime you&rsquo;re done executing!</font></li></ul></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p><font color="#000000" face="Tahoma">Again, here&rsquo;s some sample code:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="color: blue; font-family: Consolas;">protected</span><span style="font-family: Consolas;"><font color="#000000"> </font><span style="color: blue;">override</span><font color="#000000"> </font><span style="color: teal;">ActivityExecutionStatus</span><font color="#000000"> Execute(</font><span style="color: teal;">ActivityExecutionContext</span><font color="#000000"> context)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( context </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: blue;">null</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">throw</span><font color="#000000"> </font><span style="color: blue;">new</span><font color="#000000"> </font><span style="color: teal;">ArgumentNullException</span><font color="#000000">(</font><span style="color: maroon;">"context"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">TraceUtil</span><span style="color: blue;">.</span><font color="#000000">WriteInfo(</font><span style="color: maroon;">"MsmqReceiveActivity::Execute()"</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; <o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; If there are messages pending in the WorkflowQueue<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; it means we are inside an EventDrivenActivity, since we <o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; previously subscribed to the msmq queue as requested by<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; our parent activity. We can just process it and exit.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; If not, then we reuse our existing mechanism by subcribing<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; to messages (thus requesting the MsmqListenerService to<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; monitor the queue), and waiting for the notification to<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; end. We appear to execute asynchronously to the runtime<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; because of this.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( ProcessMessageFromQueue(context) )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">return</span><font color="#000000"> </font><span style="color: teal;">ActivityExecutionStatus</span><span style="color: blue;">.</span><font color="#000000">Closed;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>((</font><span style="color: teal;">IEventActivity</span><font color="#000000">)</font><span style="color: blue;">this</span><font color="#000000">)</font><span style="color: blue;">.</span><font color="#000000">Subscribe(context, </font><span style="color: blue;">this</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>_activitySubscribed </font><span style="color: blue;">=</span><font color="#000000"> </font><span style="color: blue;">true</span><font color="#000000">;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">return</span><font color="#000000"> </font><span style="color: teal;">ActivityExecutionStatus</span><span style="color: blue;">.</span><font color="#000000">Executing;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="color: blue; font-family: Consolas;">void</span><span style="font-family: Consolas;"><font color="#000000"> </font><span style="color: teal;">IActivityEventListener</span><span style="color: blue;"><</span><font color="#000000">QueueEventArgs</font><span style="color: blue;">>.</span><font color="#000000">OnEvent(</font><span style="color: blue;">object</span><font color="#000000"> sender, </font><span style="color: teal;">QueueEventArgs</span><font color="#000000"> e)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; An event has been triggered at our workflow queue.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; However, this is only triggered if the direct subscriber<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; to the event is ourselves (and not our parent activity), which<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; only happens for us when running outside of an EventDrivenActivity.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">TraceUtil</span><span style="color: blue;">.</span><font color="#000000">WriteInfo(</font><span style="color: maroon;">"MsmqReceiveActivity::OnEvent() - {0}"</span><font color="#000000">, ExecutionStatus);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( ExecutionStatus </font><span style="color: blue;">==</span><font color="#000000"> </font><span style="color: teal;">ActivityExecutionStatus</span><span style="color: blue;">.</span><font color="#000000">Executing )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: teal;">ActivityExecutionContext</span><font color="#000000"> context </font><span style="color: blue;">=</span><font color="#000000"> (</font><span style="color: teal;">ActivityExecutionContext</span><font color="#000000">)sender;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( ProcessMessageFromQueue(context) )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context</font><span style="color: blue;">.</span><font color="#000000">CloseActivity();<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="color: blue; font-family: Consolas;">private</span><span style="font-family: Consolas;"><font color="#000000"> </font><span style="color: blue;">bool</span><font color="#000000"> ProcessMessageFromQueue(</font><span style="color: teal;">ActivityExecutionContext</span><font color="#000000"> context)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: teal;">WorkflowQueuingService</span><font color="#000000"> queueSvc </font><span style="color: blue;">=</span><font color="#000000"> (</font><span style="color: teal;">WorkflowQueuingService</span><font color="#000000">)<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context</font><span style="color: blue;">.</span><font color="#000000">GetService(</font><span style="color: blue;">typeof</span><font color="#000000">(</font><span style="color: teal;">WorkflowQueuingService</span><font color="#000000">));<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; If the workflow queue exists, and it contains an event<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; then we extract it and process it. It should contain the <o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; MessageDataEventArgs sent by the MsmqListenerService<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47; when it received the message from the MSMQ Queue.<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: green;">&#47;&#47;<o:p></o:p></span></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( queueSvc</font><span style="color: blue;">.</span><font color="#000000">Exists(_wfQueueName) )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: teal;">WorkflowQueue</span><font color="#000000"> queue </font><span style="color: blue;">=</span><font color="#000000"> queueSvc</font><span style="color: blue;">.</span><font color="#000000">GetWorkflowQueue(_wfQueueName);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( queue</font><span style="color: blue;">.</span><font color="#000000">Count </font><span style="color: blue;">></span><font color="#000000"> </font><span style="color: blue;">0</span><font color="#000000"> )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: teal;">MessageDataEventArgs</span><font color="#000000"> data </font><span style="color: blue;">=</span><font color="#000000"> (</font><span style="color: teal;">MessageDataEventArgs</span><font color="#000000">)queue</font><span style="color: blue;">.</span><font color="#000000">Dequeue();<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>OnMessageReceived(</font><span style="color: blue;">this</span><font color="#000000">, data);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">if</span><font color="#000000"> ( _activitySubscribed )<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>((</font><span style="color: teal;">IEventActivity</span><font color="#000000">)</font><span style="color: blue;">this</span><font color="#000000">)</font><span style="color: blue;">.</span><font color="#000000">Unsubscribe(context, </font><span style="color: blue;">this</span><font color="#000000">);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>queueSvc</font><span style="color: blue;">.</span><font color="#000000">DeleteWorkflowQueue(_wfQueueName);<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><span style="color: blue;">return</span><font color="#000000"> </font><span style="color: blue;">true</span><font color="#000000">;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000"><span style="">&nbsp;&nbsp; </span>}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><span style=""><font color="#000000">&nbsp;&nbsp; </font></span><span style="color: blue;">return</span><font color="#000000"> </font><span style="color: blue;">false</span><font color="#000000">;<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt; text-align: left;" align="left"><span style="font-family: Consolas;"><font color="#000000">}<o:p></o:p></font></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: Consolas;"><o:p><font color="#000000">&nbsp;</font></o:p></span></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">As you can see here, if your activity is not inside an EventDrivenActivity, it should basically execute in an asynchronous fashion. This is logical, if you consider that despite it being executed by the workflow runtime at one point in time, your activity&rsquo;s purpose is still to wait for an external event</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><b style=""><font color="#000000"><font face="Tahoma">Other things to consider<o:p></o:p></font></font></b></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">There are a few other things you&rsquo;ll want to take into account when implementing Event Activities:</font></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<ul style="margin-top: 0in;" type="disc">
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">If your activity&rsquo;s execution is canceled, then you&rsquo;ll want to cancel any outstanding subscriptions you have with your runtime service.</font><br />
</li>
<li class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">If your Event Activity is located as one branch of a ListenActivity, and the other branch event is fired first, your activity instance will not be canceled. Instead, all that will happen is that the parent EventDrivenActivity will unsubscribe from you. I&rsquo;m not sure why Cancel() is not called in this scenario (it seems like the logical thing to do, to me); it might be because since your activity&rsquo;s Execute() has never been called, and thus there should be nothing to Cancel. However, I do thing this might lead to problems because there is no clear finalization point here, which might mean that you might miss an opportunity to do early clean up of allocated resources (like your workflow queue).</font></li></ul></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><o:p><font color="#000000" face="Tahoma">&nbsp;</font></o:p></p></p>
<p class="MsoNormal" style="margin: 0in 0in 0pt;"><font color="#000000" face="Tahoma">Furthermore, it seems to me like a lot of this is basically boilerplate code, so I do believe there is space here to implement helper classes that could simplify the creation of robust Event Activities.</font></p></p>
<p></p><!--end_raw--></p>
