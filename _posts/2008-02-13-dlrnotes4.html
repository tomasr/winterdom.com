---
layout: post
status: publish
published: true
title: DLR Notes 4
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 1019
wordpress_url: http://winterdom.com/2008/02/dlrnotes4
date: '2008-02-13 07:00:33 +0000'
date_gmt: '2008-02-13 07:00:33 +0000'
categories:
- ".NET"
- DLR
tags: []
comments: []
---
<p><!--start_raw-->
<p>I thought I'd use a few posts to talk a bit about some interesting ways that IronRuby does things. To do this effectively, we need to have a way to look at the code that IronRuby generates, as just browsing the code isn't going to do much good if you don't know where to start!</p>
<p>Fortunately, the DLR has our backs covered! As I've mentioned in the past, the DLR allows as to see the ASTs used for code generation as well as the Rules used to execute actions, and this is an invaluable tool both to debug our own language implementations, as well as to see what other implementations are doing.</p>
<p>Looking at both ASTs and Rules is easy if you're using the DLR Console either to execute a script in a file or in REPL mode, using the &#47;X:ShowASTs and &#47;X:ShowRules switches, like this:</p>
<div class="codebg">.\rbx &#47;X:ShowASTs test.rb </div><br />
<h2>Creating .NET Objects</h2>
<p>One of the strengths of IronRuby is that it allows us to work against not only all the Ruby goodness, but also access a lot of the functionality already available in the .NET Framework [1]. </p>
<p>For example, I could create an instance of System.Text.UTF8Encoding like this:</p>
<div class="codebg">x = <span class="Type">System</span>::<span class="Type">Text</span>::<span class="Type">UTF8Encoding</span>.new(<span class="Constant">false</span>)     <br &#47;></div>
<p>So what happens when we do this? The current implementation of IronRuby will generate an AST that looks like this:</p>
<div class="codebg"><span class="Statement">.return</span> (<span class="Statement">.bound</span>&#160;<span class="Identifier">x</span>) = (<span class="Identifier">Object</span>)<span class="Statement">.action</span> (<span class="Identifier">Object</span>) <span class="Identifier">InvokeMember</span>&#160;<span class="Identifier">new</span>(     <br &#47;>&#160;&#160;&#160; (<span class="Identifier">RubyOps</span><span class="Statement">.GetConstantExplicit</span>)(     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Identifier">RubyOps</span><span class="Statement">.GetConstantExplicit</span>)(     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Identifier">RubyOps</span><span class="Statement">.GetGlobalConstant</span>)(     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Statement">.context</span>,     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Identifier">SymbolId</span>)<span class="Identifier">System</span>,     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Statement">.context</span>,     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Identifier">SymbolId</span>)<span class="Identifier">Text</span>,     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160; ),     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Statement">.context</span>,     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Identifier">SymbolId</span>)<span class="Identifier">UTF8Encoding</span>,     <br &#47;>&#160;&#160;&#160; )     <br &#47;>&#160;&#160;&#160; (<span class="Identifier">Boolean</span>)<span class="Identifier">False</span>     <br &#47;>); </div>
<p>There are several interesting things about this tree. As you can see, the qualified class name is translated to an object through a series of calls to methods in the RubyOps class. The first two calls return RubyModule objects corresponding to the "System" and "System::Text" namespace, while the last one returns a RubyClass object representing the type for the UTF8Encoding class. Then an InvokeMember action is built to call the "new" method in this RubyClass object, which will return the new instance of the UTF8Encoding class.</p>
<p>However, if you go and look at the code for the RubyClass and RubyModule classes, you won't find a "new" method anywhere. What gives?</p>
<p>The trick is, of course, in the IDynamicObject implementation of RubyClass&#47;RubyModule, which receives the InvokeMember action and generates the right set of rules for this case. The method doesn't need to exists, as long as we can resolve the call and build a StandardRule whose target involves the right action&#47;call being executed at runtime. In our simple example, this should mean creating a new instance of UTF8Encoding, which we can see</p>
<div class="codebg">&#47;&#47;    <br &#47;>&#47;&#47; <span class="Identifier">AST</span>&#160;<span class="Identifier">Rule</span><span class="Statement">.Test</span>     <br &#47;>&#47;&#47;     <br &#47;>    <br &#47;>((((<span class="Statement">.bound</span> $<span class="Identifier">arg0</span>) == (<span class="Identifier">RubyClass</span>)<span class="Identifier">Ruby</span><span class="Statement">.Builtins.RubyClass</span>) &amp;&amp; ((<span class="Identifier">RubyClass</span>)<span class="Identifier">Ruby</span><span class="Statement">.Builtins.RubyClass.Version</span> ==     <br &#47;><span class="Constant">15111</span>)) &amp;&amp; (<span class="Identifier">Boolean</span>)<span class="Identifier">True</span>)     <br &#47;>&#47;&#47;     <br &#47;>&#47;&#47; <span class="Identifier">AST</span>&#160;<span class="Identifier">Rule</span><span class="Statement">.Target</span>     <br &#47;>&#47;&#47;     <br &#47;>    <br &#47;><span class="Statement">.return</span>&#160;<span class="Statement">.comma</span> {     <br &#47;>&#160;&#160;&#160; (<span class="Statement">.bound</span>&#160;<span class="Identifier">val</span>) = <span class="Statement">.new</span>&#160;<span class="Identifier">UTF8Encoding</span>(     <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160; (<span class="Statement">.bound</span> $<span class="Identifier">arg1</span>),     <br &#47;>&#160;&#160;&#160; )     <br &#47;>&#160;&#160;&#160; (<span class="Statement">.bound</span>&#160;<span class="Identifier">val</span>)     <br &#47;>} </div>
<p>The process through which IronRuby builds new instances (or rather, derives the right set of rules for a new expression) is actually fairly complex; even for this simple case. However, in the end, you can think of this process in a simplified way:</p>
<ol>
<li>The GetRule() implementation resolves the "new" method call in the RubyClass object by based on a fairly complicated set of lookups around the underlying .NET type and its superclasses and their corresponding RubyClass objects. What matters to us is that, at some point, IronRuby realizes that it really means "create a new instance", </li>
<li>RubyClass.SetRuleForCreateInstance() is invoked, which will configure the rule correctly for this case. </li>
<li>Within this, IronRuby notes that UTF8Encoding isn't a class defined in Ruby, but actually a CLR type. </li>
<li>The set of candidate constructors of the CLR type is evaluated to find the right constructor to use. </li>
<li>A New Expression (Tree.Ast.New()) is provided as the target of the rule. </li> </ol>
<p>So this is how our original InvokeMember action is converted into a new expression! Actually, this is a pretty simple case as far as IronRuby goes, because UTF8Encoding doesn't something corresponding in the Ruby language. To see a different scenario try creating an ArrayList (or other object that implements IList) and you will see a lot more interesting things going on to make the object and its class act ruby-like.</p><br />
<h2>What about my language?</h2>
<p>Does this mean you have to do it the same way when implementing your own language on the DLR? Certainly not. There are many ways you can choose to implement it and the DLR actually provides a few ways for that. </p>
<p>For example, in this particular scenario IronRuby is relying on an InvokeMember action, but the DLR also has a Create action which provides another way to represent your object construction. You still need to provide a callable object (IDynamicObject) to provide the rule, but it might not necessarily be very complicated once you resolve the typename to a CLR type. </p>
<p>Of course, the trick is finding<br />
out the right constructor to invoke for a given expression, and fortunately, the DLR provides some help to do this with the MethodBinder class. Here's a pretty minimal (not particularly efficient) implementation&#160; you could start with:</p>
<div class="codebg"><span class="Statement">private</span>&#160;<span class="Type">void</span> SetCreateRule<span class="Statement">(</span>StandardRule rule<span class="Statement">,</span> ActionBinder binder<span class="Statement">,</span> CodeContext context<span class="Statement">,</span>&#160;<span class="Statement">object</span><span class="Statement">[]</span> args<span class="Statement">)</span>&#160;<span class="Statement">{</span>    <br &#47;>&#160;&#160; rule<span class="Statement">.</span>AddTest<span class="Statement">(</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; Tree<span class="Statement">.</span>Ast<span class="Statement">.</span>Equal<span class="Statement">(</span>rule<span class="Statement">.</span>Parameters<span class="Statement">[</span>0<span class="Statement">],</span> Tree<span class="Statement">.</span>Ast<span class="Statement">.</span>Constant<span class="Statement">(</span><span class="Type">this</span><span class="Statement">))</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; <span class="Statement">);</span>    <br &#47;>    <br &#47;>&#160;&#160; <span class="Type">Type</span><span class="Statement">[]</span> argTypes <span class="Statement">=</span>&#160;<span class="Statement">new</span>&#160;<span class="Type">Type</span><span class="Statement">[</span>args<span class="Statement">.</span>Length<span class="Statement">-</span>1<span class="Statement">];</span>    <br &#47;>&#160;&#160; <span class="Statement">for</span>&#160;<span class="Statement">(</span>&#160;<span class="Type">int</span> i<span class="Statement">=</span>0<span class="Statement">;</span> i <span class="Statement"><</span> argTypes<span class="Statement">.</span>Length<span class="Statement">;</span> i<span class="Statement">++</span>&#160;<span class="Statement">)</span>&#160;<span class="Statement">{</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; argTypes<span class="Statement">[</span>i<span class="Statement">]</span>&#160;<span class="Statement">=</span> CompilerHelpers<span class="Statement">.</span>GetType<span class="Statement">(</span>args<span class="Statement">[</span>i<span class="Statement">+</span>1<span class="Statement">]);</span>&#160; <br &#47;>&#160;&#160; <span class="Statement">}</span>    <br &#47;>    <br &#47;>&#160;&#160; ConstructorInfo<span class="Statement">[]</span> all <span class="Statement">=</span> ClrType<span class="Statement">.</span>GetConstructors<span class="Statement">();</span>    <br &#47;>&#160;&#160; MethodBinder methodBinder <span class="Statement">=</span> MethodBinder<span class="Statement">.</span>MakeBinder<span class="Statement">(</span>binder<span class="Statement">,</span>&#160;<span class="Constant">".ctor"</span><span class="Statement">,</span> all<span class="Statement">);</span>    <br &#47;>&#160;&#160; BindingTarget target <span class="Statement">=</span> methodBinder<span class="Statement">.</span>MakeBindingTarget<span class="Statement">(</span>CallType<span class="Statement">.</span>None<span class="Statement">,</span> argTypes<span class="Statement">);</span>    <br &#47;>&#160;&#160; <span class="Statement">if</span>&#160;<span class="Statement">(</span> target<span class="Statement">.</span>Success <span class="Statement">)</span>&#160;<span class="Statement">{</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; Tree<span class="Statement">.</span>Expression<span class="Statement">[]</span> actualArgs <span class="Statement">=</span> ArrayUtils<span class="Statement">.</span>RemoveFirst<span class="Statement">(</span>rule<span class="Statement">.</span>Parameters<span class="Statement">);</span>    <br &#47;>    <br &#47;>&#160;&#160;&#160;&#160;&#160; rule<span class="Statement">.</span>Target <span class="Statement">=</span> rule<span class="Statement">.</span>MakeReturn<span class="Statement">(</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; binder<span class="Statement">,</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; target<span class="Statement">.</span>MakeExpression<span class="Statement">(</span>rule<span class="Statement">,</span> actualArgs<span class="Statement">)</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; <span class="Statement">);</span>    <br &#47;>&#160;&#160; <span class="Statement">}</span>&#160;<span class="Statement">else</span>&#160;<span class="Statement">{</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; rule<span class="Statement">.</span>Target <span class="Statement">=</span> rule<span class="Statement">.</span>MakeError<span class="Statement">(</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Tree<span class="Statement">.</span>Ast<span class="Statement">.</span>Call<span class="Statement">(</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; GetType<span class="Statement">().</span>GetMethod<span class="Statement">(</span><span class="Constant">"InvalidArgs"</span><span class="Statement">)</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="Statement">)</span>    <br &#47;>&#160;&#160;&#160;&#160;&#160; <span class="Statement">);</span>    <br &#47;>&#160;&#160; <span class="Statement">}</span>    <br &#47;><span class="Statement">}</span> </div>
<p><strong>[1]</strong> The examples in this post assume you're 'require'-ing mscorlib.dll.</p>
<div class="wlWriterSmartContent" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:64bca58d-882d-492a-ac1f-d8524b78a894" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati tags: <a href="http:&#47;&#47;technorati.com&#47;tags&#47;Dynamic%20Language%20Runtime" rel="tag">Dynamic Language Runtime</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;DLR" rel="tag">DLR</a>, <a href="http:&#47;&#47;technorati.com&#47;tags&#47;.NET" rel="tag">.NET</a></div><!--end_raw--></p>
