---
layout: post
status: publish
published: true
title: Connecting to Multiple DBs and NHibernate
author:
  display_name: Tomas Restrepo
  login: tomasr
  email: tomas@winterdom.com
  url: http://winterdom.com/
author_login: tomasr
author_email: tomas@winterdom.com
author_url: http://winterdom.com/
wordpress_id: 62
wordpress_url: http://winterdom.com/2006/07/connectingtomultipledbsandnhibernate
date: '2006-07-27 13:36:22 +0000'
date_gmt: '2006-07-27 13:36:22 +0000'
categories:
- ".NET"
- NHibernate
tags: []
comments:
- id: 50
  author: Ayende Rahien
  author_email: Ayende@ayende.com
  author_url: http://www.ayende.com/Blog/
  date: '2006-07-27 14:37:13 +0000'
  date_gmt: '2006-07-27 14:37:13 +0000'
  content: |
    A better solution would be to use two session factories, one per each database.
    I am guessing that you are managing it yourself using the overload that allow passing a IdbConnection, since NHib usually will not let you work against 2 DB in the same session factory.
---
<p><!--start_raw--><EM>"Let him who hath understanding<BR>reckon the number of the beast<BR>for it is a human number<BR>its number is one.zero.two"<BR><BR></EM>I just spend the better part of today trying to figure out why NHibernate 1.0.2 was generating incorrect SQL for a query. The situation was like this:<BR><BR>I had a simple class hierarchy consisting on a simple <class> mapping of table "Contacts" with a single <joined-subclass&#47;> on the table ClientContacts. Both tables were matched together with a HistoryId identity column. The Contacts table also contained a uniqueidentitier column called ContactId, but that was not part of any index or constraint whatsoever.<BR><BR>The problem appeared when I started trying to query (using ISession.Find()) for objects of type ClientContactHistory. NHibernate would then generate completely invalid SQL trying to do the join between the two&nbsp;tables based on&nbsp;the "ContactId" column instead of the "HistoryId" one. WTF?<BR><BR>You might think my mapping file was incorrect. Well, no, it wasn't. Here's what my mapping file contained:<BR><BR><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">class</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> <?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" &#47;><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">N.ClientContactHistoryBase, N</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue"> <o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">polymorphism</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">explicit</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue"> <o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">mutable</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">false</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue"> <o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">table</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">Contacts><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">id</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">HistoryId</SPAN><FONT color=#000000>'<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">column</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">HistoryId</SPAN><FONT color=#000000>'<o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">access</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">property</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">generator</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">class</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">identity</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue"> &#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"></</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">id</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">property</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">ChangeDate</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">&#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">property</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">ChangeType</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">&#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">property</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">Username</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">&#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">joined-subclass</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> <o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>"</FONT><SPAN style="COLOR: blue">N.ClientContactHistory, N</SPAN><FONT color=#000000>"</FONT><SPAN style="COLOR: blue"> <o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN></SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">table</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>"</FONT><SPAN style="COLOR: blue">ClientContacts</SPAN><FONT color=#000000>"</FONT><SPAN style="COLOR: blue">><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">key</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">column</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>"</FONT><SPAN style="COLOR: blue">HistoryId</SPAN><FONT color=#000000>"</FONT><SPAN style="COLOR: blue">&#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><SPAN style="mso-spacerun: yes">&nbsp;&nbsp; </SPAN><</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">property</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"> </SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: red; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">name</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">=</SPAN><SPAN style="FONT-SIZE: 11pt; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">ClientId</SPAN><FONT color=#000000>'</FONT><SPAN style="COLOR: blue">&#47;><o:p></o:p></SPAN></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"></</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">joined-subclass</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas"></</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: maroon; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">class</SPAN><SPAN style="FONT-SIZE: 11pt; COLOR: blue; FONT-FAMILY: Consolas; mso-bidi-font-family: Consolas">><o:p></o:p></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P><BR><br />
<P></P><br />
<P>And this was the SQL NHibernate was generating for the query:</P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">select</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000> <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000><SPAN style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>clientcont0_</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>ContactId </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> HistoryId</FONT><SPAN style="COLOR: gray">,</SPAN><FONT color=#000000> <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000><SPAN style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>clientcont0_</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>ClientId </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> ClientId2_</FONT><SPAN style="COLOR: gray">,</SPAN><FONT color=#000000> <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000><SPAN style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>[clientcont0__1_]</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>Username </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> Username1_</FONT><SPAN style="COLOR: gray">,</SPAN><FONT color=#000000> <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000><SPAN style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>[clientcont0__1_]</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>ChangeDate </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> Change2_1_</FONT><SPAN style="COLOR: gray">,</SPAN><FONT color=#000000> <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000><SPAN style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>[clientcont0__1_]</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>ChangeType </FONT><SPAN style="COLOR: blue">as</SPAN><FONT color=#000000> Change3_1_ <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">from</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000> ClientContacts clientcont0_ <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; COLOR: gray; FONT-FAMILY: 'Courier New'">inner</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000> </FONT><SPAN style="COLOR: gray">join</SPAN><FONT color=#000000> Contacts_ [clientcont0__1_] <o:p></o:p></FONT></SPAN></P><br />
<P class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-pagination: none; mso-layout-grid-align: none"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'">on</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'"><FONT color=#000000> clientcont0_</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>ContactId</FONT><SPAN style="COLOR: gray">=</SPAN><FONT color=#000000>[clientcont0__1_]</FONT><SPAN style="COLOR: gray">.</SPAN><FONT color=#000000>HistoryId </FONT></SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><br />
<P><br />
<P>Notice how instead of using the HistoryId column I clearly specified as the key for the join, NHibernate simply took that and used it as an alias on top of a different column. </P><br />
<P>The problem turned out to be the table names themselves. The application I'm working on opens connections to two different databases: one which has the real business data, and one that contains only historic (audit) information. The schemas for both databases are very similar, and we had the same table names on both sides. Apparently, this confuses the heck out of NHibernate, who basically ended up trying to use information it had inferred about the DB schema from the mappings of the business DB and use them to generate the SQL to access the History DB. </P><br />
<P>The solution? Rename the tables of the History database so that they didn't clash with those in the business DB. Nasty issue.</P><br />
<P></P><!--end_raw--></p>
